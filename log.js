let allLogs = [];
let filteredLogs = [];

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    setupFilters();
    setupThemeToggle();
    setupImportExport();
    const clearBtn = document.getElementById('clearLogsBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', clearAllLogs);
    }
    const testAddBtn = document.getElementById('testAddBtn');
    if (testAddBtn) {
        testAddBtn.addEventListener('click', () => openTestLogModal(0));
    }
});

// ÌÖåÎßà ÌÜ†Í∏Ä ÏÑ§Ï†ï
function setupThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    
    // Ï†ÄÏû•Îêú ÌÖåÎßà Î∂àÎü¨Ïò§Í∏∞ (Í∏∞Î≥∏Í∞í: Îã§ÌÅ¨Î™®Îìú)
    const savedTheme = localStorage.getItem('theme') || 'dark';
    body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
    
    // ÌÖåÎßà ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏
    themeToggle.addEventListener('click', () => {
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    });
}

// ÌÖåÎßà ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
function updateThemeIcon(theme) {
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    themeToggle.title = theme === 'dark' ? 'ÎùºÏù¥Ìä∏Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω' : 'Îã§ÌÅ¨Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω';
}

// ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º Ïú†Ìã∏
let toastContainer;
function ensureToastResources() {
	if (!toastContainer) {
		toastContainer = document.createElement('div');
		toastContainer.id = 'toastContainer';
		document.body.appendChild(toastContainer);
	}
	if (!document.getElementById('toastStyles')) {
		const style = document.createElement('style');
		style.id = 'toastStyles';
		style.textContent = `
			#toastContainer { position: fixed; right: 16px; bottom: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
			.toast { min-width: 200px; max-width: 360px; padding: 10px 12px; border-radius: 8px; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(8px); transition: opacity .2s ease, transform .2s ease; font-size: 13px; }
			.toast.show { opacity: 1; transform: translateY(0); }
			.toast-info { background: #4b5563; }
			.toast-success { background: #16a34a; }
			.toast-error { background: #dc2626; }
		`;
		document.head.appendChild(style);
	}
}

function showToast(message, type = 'info', durationMs = 1500) {
	ensureToastResources();
	const el = document.createElement('div');
	el.className = `toast toast-${type}`;
	el.textContent = message;
	toastContainer.appendChild(el);
	// Ïï†ÎãàÎ©îÏù¥ÏÖò ÌëúÏãú
	requestAnimationFrame(() => el.classList.add('show'));
	// ÏûêÎèô Ï†úÍ±∞
	setTimeout(() => {
		el.classList.remove('show');
		setTimeout(() => {
			if (el.parentNode) el.parentNode.removeChild(el);
		}, 200);
	}, durationMs);
}

// ÌôïÏù∏ Î™®Îã¨ Ïú†Ìã∏ (Í∏∞Ï°¥ Ìé∏Ïßë Î™®Îã¨ Ïä§ÌÉÄÏùº Ïû¨ÏÇ¨Ïö©)
function ensureConfirmResources() {}

function showConfirm(message, { title = 'ÌôïÏù∏', okText = 'ÌôïÏù∏', cancelText = 'Ï∑®ÏÜå', destructive = false } = {}) {
	ensureConfirmResources();
	return new Promise((resolve) => {
		const overlay = document.createElement('div');
		overlay.className = 'edit-modal-overlay';
		const modal = document.createElement('div');
		modal.className = 'edit-modal';
		modal.innerHTML = `
			<div class="edit-modal-header">
				<h3>${title}</h3>
				<button class="close-btn" id="closeConfirmModal">√ó</button>
			</div>
			<div class="edit-modal-content">
				<div style="font-size:14px; line-height:1.6;">${message}</div>
			</div>
			<div class="edit-modal-footer">
				<button class="cancel-btn" id="confirmCancelBtn">${cancelText}</button>
				<button class="${destructive ? 'modal-delete-btn' : 'save-btn'}" id="confirmOkBtn">${okText}</button>
			</div>
		`;
		overlay.appendChild(modal);
		document.body.appendChild(overlay);

		const cleanup = () => { if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); };
		overlay.addEventListener('click', (e) => { if (e.target === overlay) { cleanup(); resolve(false); } });
		modal.querySelector('#closeConfirmModal').addEventListener('click', () => { cleanup(); resolve(false); });
		modal.querySelector('#confirmCancelBtn').addEventListener('click', () => { cleanup(); resolve(false); });
		modal.querySelector('#confirmOkBtn').addEventListener('click', () => { cleanup(); resolve(true); });
		// ESC ÌÇ§ Ï≤òÎ¶¨
		document.addEventListener('keydown', function onKey(e){ if(e.key==='Escape'){ document.removeEventListener('keydown', onKey); cleanup(); resolve(false);} });
	});
}

// Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
async function loadLogs() {
    try {
        const result = await chrome.storage.local.get(['powerLogs']);
        allLogs = result.powerLogs || [];
        filteredLogs = [...allLogs];
        
        updateStats();
        renderLogs();
        
        // Î°úÎî© Ïà®Í∏∞Í∏∞
        document.getElementById('loading').style.display = 'none';
    } catch (error) {
        console.error('Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®:', error);
        document.getElementById('loading').innerHTML = '<p>Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.</p>';
    }
}

// ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
function updateStats() {
    // Í∏∞Í∞ÑÎ≥Ñ ÏßëÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
    updatePeriodStats();
}

// Í∏∞Í∞ÑÎ≥Ñ ÏßëÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
function updatePeriodStats() {
    const now = new Date();
    
    // Ïò§Îäò
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const todayLogs = allLogs.filter(log => {
        const logDate = new Date(log.timestamp);
        return logDate >= today;
    });
    const todayCount = todayLogs.length;
    const todayPower = todayLogs.reduce((sum, log) => {
        const amount = typeof log.amount === 'number' ? log.amount : 0;
        return sum + amount;
    }, 0);
    const todayChannels = new Set(todayLogs.map(log => log.channelId)).size;
    
    // Ïù¥Î≤à Ï£º (ÏõîÏöîÏùºÎ∂ÄÌÑ∞)
    const startOfWeek = new Date(today);
    const dayOfWeek = now.getDay();
    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    startOfWeek.setDate(today.getDate() - daysToMonday);
    const weekLogs = allLogs.filter(log => {
        const logDate = new Date(log.timestamp);
        return logDate >= startOfWeek;
    });
    const weekCount = weekLogs.length;
    const weekPower = weekLogs.reduce((sum, log) => {
        const amount = typeof log.amount === 'number' ? log.amount : 0;
        return sum + amount;
    }, 0);
    const weekChannels = new Set(weekLogs.map(log => log.channelId)).size;
    
    // Ïù¥Î≤à Îã¨
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthLogs = allLogs.filter(log => {
        const logDate = new Date(log.timestamp);
        return logDate >= startOfMonth;
    });
    const monthCount = monthLogs.length;
    const monthPower = monthLogs.reduce((sum, log) => {
        const amount = typeof log.amount === 'number' ? log.amount : 0;
        return sum + amount;
    }, 0);
    const monthChannels = new Set(monthLogs.map(log => log.channelId)).size;
    
    // Ï†ÑÏ≤¥ Í∏∞Í∞Ñ
    const allCount = allLogs.length;
    const allPower = allLogs.reduce((sum, log) => {
        const amount = typeof log.amount === 'number' ? log.amount : 0;
        return sum + amount;
    }, 0);
    const allChannels = new Set(allLogs.map(log => log.channelId)).size;
    
    // ÎÇ†Ïßú Î≤îÏúÑ ÏÑ§Ï†ï
    const todayDate = now.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
    const weekStartDate = startOfWeek.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
    const weekEndDate = now.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
    const monthDate = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });
    
    // Ï†ÑÏ≤¥ Í∏∞Í∞Ñ ÎÇ†Ïßú (Ï≤´ Î°úÍ∑∏Î∂ÄÌÑ∞)
    let allDateRange = 'Ï†ÑÏ≤¥';
    if (allLogs.length > 0) {
        const firstLog = new Date(allLogs[allLogs.length - 1].timestamp);
        const lastLog = new Date(allLogs[0].timestamp);
        allDateRange = `${firstLog.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })} ~ ${lastLog.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}`;
    }
    
    // DOM ÏóÖÎç∞Ïù¥Ìä∏
    document.getElementById('todayCount').textContent = `${todayCount}Ìöå`;
    document.getElementById('todayPower').textContent = `${todayPower.toLocaleString()}Í∞ú`;
    document.getElementById('todayChannels').textContent = `${todayChannels}Í∞ú`;
    document.getElementById('todayDate').textContent = todayDate;
    
    document.getElementById('weekCount').textContent = `${weekCount}Ìöå`;
    document.getElementById('weekPower').textContent = `${weekPower.toLocaleString()}Í∞ú`;
    document.getElementById('weekChannels').textContent = `${weekChannels}Í∞ú`;
    document.getElementById('weekDate').textContent = `${weekStartDate} ~ ${weekEndDate}`;
    
    document.getElementById('monthCount').textContent = `${monthCount}Ìöå`;
    document.getElementById('monthPower').textContent = `${monthPower.toLocaleString()}Í∞ú`;
    document.getElementById('monthChannels').textContent = `${monthChannels}Í∞ú`;
    document.getElementById('monthDate').textContent = monthDate;
    
    document.getElementById('allCount').textContent = `${allCount}Ìöå`;
    document.getElementById('allPower').textContent = `${allPower.toLocaleString()}Í∞ú`;
    document.getElementById('allChannels').textContent = `${allChannels}Í∞ú`;
    document.getElementById('allDate').textContent = allDateRange;
}

// Î°úÍ∑∏ Î†åÎçîÎßÅ
function renderLogs() {
    const logsList = document.getElementById('logsList');
    
    if (filteredLogs.length === 0) {
        logsList.innerHTML = `
            <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 16px;">üå≤</div>
                <h3>Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
                <p>ÏπòÏßÄÏßÅÏóêÏÑú ÌÜµÎÇòÎ¨¥ ÌååÏõåÎ•º ÌöçÎìùÌïòÎ©¥<br>Ïó¨Í∏∞Ïóê Í∏∞Î°ùÏù¥ ÌëúÏãúÎê©ÎãàÎã§.</p>
            </div>
        `;
        return;
    }
    
    logsList.innerHTML = filteredLogs.map(log => {
        const date = new Date(log.timestamp);
        const formattedDate = date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const methodClass = getMethodClass(log.method);
        let methodText = getMethodText(log.method);
        // VIEW + Íµ¨ÎèÖ Ìã∞Ïñ¥Î≥Ñ ÎùºÎ≤® Î≥¥Í∞ï
        if (String(log.method || '').toUpperCase() === 'VIEW') {
            const amt = typeof log.amount === 'number' ? log.amount : NaN;
            if (amt === 120) methodText = 'ÏãúÏ≤≠ - 1Ìã∞Ïñ¥ Íµ¨ÎèÖ';
            else if (amt === 200) methodText = 'ÏãúÏ≤≠ - 2Ìã∞Ïñ¥ Íµ¨ÎèÖ';
        }
        
        return `
            <div class="log-item" data-log-index="${filteredLogs.indexOf(log)}">
                <img src="${log.channelImageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNFMkU4RjAiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0VjEwQzE0IDExLjEgMTMuMSAxMiAxMiAxMkMxMC45IDEyIDEwIDExLjEgMTAgMTBWNFMxMC45IDIgMTIgMloiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTEyIDE0QzEzLjEgMTQgMTQgMTQuOSAxNCAxNlYyMEMxNCAyMS4xIDEzLjEgMjIgMTIgMjJDMTAuOSAyMiAxMCAyMS4xIDEwIDIwVjE2QzEwIDE0LjkgMTAuOSAxNCAxMiAxNFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPg=='}" 
                     alt="${log.channelName}" class="channel-image">
                <div class="log-content">
                    <div class="channel-name">
                        <a href="https://chzzk.naver.com/${log.channelId}" target="_blank" class="channel-link">
                            ${log.channelName}${log.verifiedMark ? ' <img src="https://ssl.pstatic.net/static/nng/glive/resource/p/static/media/icon_official.a53d1555f8f4796d7862.png" alt="Ïù∏Ï¶ù" style="width:16px;height:16px;vertical-align:middle;margin-left:2px;">' : ''}
                        </a>
                    </div>
                    <div class="log-details">
                        <span class="method-badge ${methodClass}">${methodText}</span>
                        <span class="timestamp">${formattedDate}</span>
                    </div>
                </div>
                <div class="log-actions">
                    <div class="amount">+${typeof log.amount === 'number' ? log.amount.toLocaleString() : log.amount}</div>
                    <div class="action-buttons">
                        <button class="edit-btn" data-log-index="${filteredLogs.indexOf(log)}">ÏàòÏ†ï</button>
                        <button class="delete-btn" data-log-index="${filteredLogs.indexOf(log)}">ÏÇ≠Ï†ú</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    addEventListeners();
}

// Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä Ìï®Ïàò
function addEventListeners() {
    // Ìé∏Ïßë Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const logIndex = parseInt(e.target.getAttribute('data-log-index'));
            editLog(logIndex);
        });
    });
    
    // ÏÇ≠Ï†ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const logIndex = parseInt(e.target.getAttribute('data-log-index'));
            deleteLog(logIndex);
        });
    });

    // ÌÖåÏä§Ìä∏ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    document.querySelectorAll('.test-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const logIndex = parseInt(e.target.getAttribute('data-log-index'));
            openTestLogModal(logIndex);
        });
    });
}

// Î∞©ÏãùÎ≥Ñ ÌÅ¥ÎûòÏä§ Î∞òÌôò
function getMethodClass(method) {
    method = method.toLowerCase();
    switch (method) {
        case 'follow': return 'method-follow';
        case 'view': return 'method-view';
        case 'remember': return 'method-remember';
        default: return method;
    }
}

// Î∞©ÏãùÎ≥Ñ ÌÖçÏä§Ìä∏ Î∞òÌôò
function getMethodText(method) {
    method = method.toLowerCase();
    switch (method) {
        case 'follow': return 'ÌåîÎ°úÏö∞';
        case 'view': return 'ÏãúÏ≤≠';
        case 'remember': return 'Í∏∞Ïñµ';
        default: return 'Í∏∞ÌÉÄ';
    }
}

// ÌïÑÌÑ∞ ÏÑ§Ï†ï
function setupFilters() {
    const methodFilter = document.getElementById('methodFilter');
    const channelFilter = document.getElementById('channelFilter');
    const dateFilter = document.getElementById('dateFilter');
    
    methodFilter.addEventListener('change', applyFilters);
    channelFilter.addEventListener('input', applyFilters);
    dateFilter.addEventListener('change', applyFilters);
}

// ÌïÑÌÑ∞ Ï†ÅÏö©
function applyFilters() {
    const methodFilter = document.getElementById('methodFilter').value;
    const channelFilter = document.getElementById('channelFilter').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    
    filteredLogs = allLogs.filter(log => {
        // Î∞©Ïãù ÌïÑÌÑ∞ (OTHERSÎäî VIEW/FOLLOW Ïù¥Ïô∏ Î™®Îëê Ìè¨Ìï®)
        if (methodFilter) {
            const method = String(log.method || '').toUpperCase();
            const filter = String(methodFilter).toUpperCase();
            if (filter === 'OTHERS') {
                if (method === 'VIEW' || method === 'FOLLOW') {
                    return false;
                }
            } else if (method !== filter) {
                return false;
            }
        }
        
        // Ï±ÑÎÑêÎ™Ö ÌïÑÌÑ∞
        if (channelFilter && !log.channelName.toLowerCase().includes(channelFilter)) {
            return false;
        }
        
        // ÎÇ†Ïßú ÌïÑÌÑ∞
        if (dateFilter) {
            const logDate = new Date(log.timestamp);
            const now = new Date();
            
            switch (dateFilter) {
                case 'today':
                    if (logDate.toDateString() !== now.toDateString()) {
                        return false;
                    }
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (logDate < weekAgo) {
                        return false;
                    }
                    break;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (logDate < monthAgo) {
                        return false;
                    }
                    break;
            }
        }
        
        return true;
    });
    
    renderLogs();
}

// Í∞úÎ≥Ñ Î°úÍ∑∏ ÏÇ≠Ï†ú
async function deleteLog(filteredIndex) {
    const log = filteredLogs[filteredIndex];
    const ok = await showConfirm(`"${log.channelName}"ÏóêÏÑú ÌöçÎìùÌïú ${log.method} Î°úÍ∑∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, { title: 'Î°úÍ∑∏ ÏÇ≠Ï†ú', okText: 'ÏÇ≠Ï†ú', cancelText: 'Ï∑®ÏÜå', destructive: true });
    if (ok) {
        try {
            // Ï†ÑÏ≤¥ Î°úÍ∑∏ÏóêÏÑú Ìï¥Îãπ Î°úÍ∑∏ Ï∞æÏïÑÏÑú ÏÇ≠Ï†ú
            const allIndex = allLogs.findIndex(l => 
                l.timestamp === log.timestamp && 
                l.channelId === log.channelId && 
                l.amount === log.amount
            );
            
            if (allIndex !== -1) {
                allLogs.splice(allIndex, 1);
                await chrome.storage.local.set({ powerLogs: allLogs });
                
                // ÌïÑÌÑ∞ÎßÅÎêú Î°úÍ∑∏ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                applyFilters();
                updateStats();
                renderLogs();
                
                showToast('Î°úÍ∑∏Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
            }
        } catch (error) {
            console.error('Î°úÍ∑∏ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
            showToast('Î°úÍ∑∏ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

// Í∞úÎ≥Ñ Î°úÍ∑∏ Ìé∏Ïßë
function editLog(filteredIndex) {
    const log = filteredLogs[filteredIndex];
    
    // Ìé∏Ïßë Ìèº ÏÉùÏÑ±
    const editForm = `
        <div class="edit-modal-overlay" id="editModalOverlay">
            <div class="edit-modal" id="editModal">
                <div class="edit-modal-header">
                    <h3>Î°úÍ∑∏ ÏàòÏ†ï</h3>
                    <button class="close-btn" id="closeEditModal">√ó</button>
                </div>
                <div class="edit-modal-content">
                    <div class="form-group">
                        <label>Ï±ÑÎÑêÎ™Ö:</label>
                        <input type="text" id="editChannelName" value="${log.channelName}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>ÌÜµÎÇòÎ¨¥ ÌååÏõå:</label>
                        <input type="number" id="editAmount" value="${log.amount}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>ÌöçÎìù Î∞©Ïãù:</label>
                        ${(() => {
                            const methodRaw = String(log.method || '').trim();
                            const methodUpper = methodRaw.toUpperCase();
                            const known = ['VIEW','FOLLOW','OTHERS'];
                            const hasUnknown = methodUpper && !known.includes(methodUpper);
                            return `
                                <select id="editMethod" class="form-input">
                                    ${hasUnknown ? `<option value="Remember" selected>Í∏∞Ïñµ</option>` : ''}
                                    <option value="VIEW" ${methodUpper === 'VIEW' ? 'selected' : ''}>ÏãúÏ≤≠</option>
                                    <option value="FOLLOW" ${methodUpper === 'FOLLOW' ? 'selected' : ''}>ÌåîÎ°úÏö∞</option>
                                    <option value="OTHERS" ${methodUpper === 'OTHERS' ? 'selected' : ''}>Í∏∞ÌÉÄ</option>
                                </select>
                            `;
                        })()}
                    </div>
                    <div class="form-group">
                        <label>ÎÇ†Ïßú/ÏãúÍ∞Ñ:</label>
                        <input type="datetime-local" id="editTimestamp" value="${new Date(new Date(log.timestamp).getTime() + 9 * 60 * 60 * 1000).toISOString().slice(0, 19)}" class="form-input" step="1">
                    </div>
                </div>
                <div class="edit-modal-footer">
                    <button class="cancel-btn" id="cancelEditModal">Ï∑®ÏÜå</button>
                    <button class="save-btn" id="saveEditModal" data-log-index="${filteredIndex}">Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', editForm);
    
    // Î™®Îã¨ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    addModalEventListeners();
}

// Î™®Îã¨ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
function addModalEventListeners() {
    // Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    const overlay = document.getElementById('editModalOverlay');
    if (overlay) {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeEditModal();
            }
        });
    }
    
    // Î™®Îã¨ ÎÇ¥Î∂Ä ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Ï§ëÏßÄ
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }
    
    // Îã´Í∏∞ Î≤ÑÌäº
    const closeBtn = document.getElementById('closeEditModal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeEditModal);
    }
    
    // Ï∑®ÏÜå Î≤ÑÌäº
    const cancelBtn = document.getElementById('cancelEditModal');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeEditModal);
    }
    
    // Ï†ÄÏû• Î≤ÑÌäº
    const saveBtn = document.getElementById('saveEditModal');
    if (saveBtn) {
        saveBtn.addEventListener('click', (e) => {
            const logIndex = parseInt(e.target.getAttribute('data-log-index'));
            saveLogEdit(logIndex);
        });
    }
}

// Ìé∏Ïßë Î™®Îã¨ Îã´Í∏∞
function closeEditModal() {
    const modal = document.querySelector('.edit-modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ÌÖåÏä§Ìä∏ Î°úÍ∑∏ Ï∂îÍ∞Ä Î™®Îã¨
function openTestLogModal(baseIndex) {
    const base = {
        channelName: 'We Remember You',
        channelId: 'f722959d1b8e651bd56209b343932c01',
        amount: 6459220000,
        method: 'Remember',
        channelImageUrl: 'https://ssl.pstatic.net/cmstatic/nng/img/img_anonymous_square_gray_opacity2x.png?type=f120_120_na',
        timestamp: new Date(Date.now() + 9 * 60 * 60 * 1000).toISOString()
    };
    const nowLocal = new Date(Date.now() + 9 * 60 * 60 * 1000).toISOString().slice(0, 19);
    const form = `
        <div class="edit-modal-overlay" id="testModalOverlay">
            <div class="edit-modal" id="testModal">
                <div class="edit-modal-header">
                    <h3>ÌÖåÏä§Ìä∏ Î°úÍ∑∏ Ï∂îÍ∞Ä</h3>
                    <button class="close-btn" id="closeTestModal">√ó</button>
                </div>
                <div class="edit-modal-content">
                    <div class="form-group">
                        <label>Channel Name:</label>
                        <input type="text" id="testChannelName" value="${base.channelName || ''}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Channel ID:</label>
                        <input type="text" id="testChannelId" value="${base.channelId || ''}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Log Power:</label>
                        <input type="number" id="testAmount" value="${typeof base.amount === 'number' ? base.amount : 1}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>method:</label>
                        <input type="text" id="testMethod" value="${base.method || 'view'}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Image URL:</label>
                        <input type="text" id="testImageUrl" value="${base.channelImageUrl || ''}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="datetime-local" id="testTimestamp" value="${nowLocal}" class="form-input" step="1">
                    </div>
                </div>
                <div class="edit-modal-footer">
                    <button class="cancel-btn" id="cancelTestModal">Ï∑®ÏÜå</button>
                    <button class="save-btn" id="saveTestModal">Ï∂îÍ∞Ä</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', form);
    // Ïù¥Î≤§Ìä∏
    const overlay = document.getElementById('testModalOverlay');
    if (overlay) {
        overlay.addEventListener('click', (e) => { if (e.target === overlay) closeTestModal(); });
    }
    const modal = document.getElementById('testModal');
    if (modal) modal.addEventListener('click', (e) => e.stopPropagation());
    const closeBtn = document.getElementById('closeTestModal');
    if (closeBtn) closeBtn.addEventListener('click', closeTestModal);
    const cancelBtn = document.getElementById('cancelTestModal');
    if (cancelBtn) cancelBtn.addEventListener('click', closeTestModal);
    const saveBtn = document.getElementById('saveTestModal');
    if (saveBtn) saveBtn.addEventListener('click', saveTestLog);
}

function closeTestModal() {
    const modal = document.getElementById('testModalOverlay');
    if (modal) modal.remove();
}

async function saveTestLog() {
    try {
        const channelName = document.getElementById('testChannelName').value.trim();
        const channelId = document.getElementById('testChannelId').value.trim();
        const amount = parseInt(document.getElementById('testAmount').value);
        const method = document.getElementById('testMethod').value.trim();
        const imageUrl = document.getElementById('testImageUrl').value.trim();
        const localValue = document.getElementById('testTimestamp').value; // local time
        const isoTimestamp = new Date(localValue).toISOString();

        if (!channelName || !channelId || !amount || !method) {
            showToast('ÌïÑÏàò Í∞íÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
            return;
        }

        const newLog = {
            channelName,
            channelId,
            amount,
            method,
            channelImageUrl: imageUrl,
            timestamp: isoTimestamp
        };

        // ÏïûÏ™ΩÏóê Ï∂îÍ∞Ä
        allLogs.unshift(newLog);
        await chrome.storage.local.set({ powerLogs: allLogs });
        applyFilters();
        updateStats();
        renderLogs();
        closeTestModal();
        showToast('ÌÖåÏä§Ìä∏ Î°úÍ∑∏Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
    } catch (e) {
        console.error(e);
        showToast('ÌÖåÏä§Ìä∏ Î°úÍ∑∏ Ï∂îÍ∞Ä Ïã§Ìå®', 'error');
    }
}

// Î°úÍ∑∏ Ìé∏Ïßë Ï†ÄÏû•
async function saveLogEdit(filteredIndex) {
    try {
        const log = filteredLogs[filteredIndex];
        const newChannelName = document.getElementById('editChannelName').value.trim();
        const newAmount = parseInt(document.getElementById('editAmount').value);
        const newMethod = document.getElementById('editMethod').value.trim(); // VIEW | FOLLOW | OTHERS
        const newTimestamp = new Date(document.getElementById('editTimestamp').value).toISOString();
        
        if (!newChannelName || !newAmount || !newMethod) {
            showToast('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
            return;
        }
        
        // Ï†ÑÏ≤¥ Î°úÍ∑∏ÏóêÏÑú Ìï¥Îãπ Î°úÍ∑∏ Ï∞æÏïÑÏÑú ÏàòÏ†ï
        const allIndex = allLogs.findIndex(l => 
            l.timestamp === log.timestamp && 
            l.channelId === log.channelId && 
            l.amount === log.amount
        );
        
        if (allIndex !== -1) {
            allLogs[allIndex] = {
                ...allLogs[allIndex],
                channelName: newChannelName,
                amount: newAmount,
                method: newMethod,
                timestamp: newTimestamp
            };
            
            await chrome.storage.local.set({ powerLogs: allLogs });
            
            // ÌïÑÌÑ∞ÎßÅÎêú Î°úÍ∑∏ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            applyFilters();
            updateStats();
            renderLogs();
            closeEditModal();
            showToast('Î°úÍ∑∏Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
        }
    } catch (error) {
        console.error('Î°úÍ∑∏ ÏàòÏ†ï Ïã§Ìå®:', error);
        showToast('Î°úÍ∑∏ ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
    }
}

// Î™®Îì† Î°úÍ∑∏ ÏÇ≠Ï†ú
async function clearAllLogs() {
    const ok = await showConfirm('Î™®Îì† Î°úÍ∑∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.', { title: 'Î™®Îì† Î°úÍ∑∏ ÏÇ≠Ï†ú', okText: 'ÏÇ≠Ï†ú', cancelText: 'Ï∑®ÏÜå', destructive: true });
    if (ok) {
        try {
            await chrome.storage.local.remove(['powerLogs']);
            allLogs = [];
            filteredLogs = [];
            updateStats();
            renderLogs();
            showToast('Î™®Îì† Î°úÍ∑∏Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
        } catch (error) {
            console.error('Î°úÍ∑∏ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
            showToast('Î°úÍ∑∏ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

// Import/Export Í∏∞Îä• ÏÑ§Ï†ï
function setupImportExport() {
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');

    if (exportBtn) {
        exportBtn.addEventListener('click', exportLogs);
    }

    if (importBtn) {
        importBtn.addEventListener('click', () => {
            importFile.click();
        });
    }

    if (importFile) {
        importFile.addEventListener('change', handleImportFile);
    }
}

// Î°úÍ∑∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
function exportLogs() {
    try {
        const exportData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            logs: allLogs
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `chzzk_power_logs_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast(`Î°úÍ∑∏ ${allLogs.length}Í∞úÍ∞Ä ÎÇ¥Î≥¥ÎÇ¥Í∏∞ÎêòÏóàÏäµÎãàÎã§.`, 'success');
    } catch (error) {
        console.error('Î°úÍ∑∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®:', error);
        showToast('Î°úÍ∑∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
    }
}

// ÌååÏùº Í∞ÄÏ†∏Ïò§Í∏∞ Ï≤òÎ¶¨
function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importData = JSON.parse(e.target.result);
            
            // Îç∞Ïù¥ÌÑ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!importData.logs || !Array.isArray(importData.logs)) {
                throw new Error('ÏûòÎ™ªÎêú ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§.');
            }

            // Í∏∞Ï°¥ Î°úÍ∑∏ÏôÄ Î≥ëÌï©Ìï†ÏßÄ ÌôïÏù∏
            if (allLogs.length > 0) {
                const shouldOverwrite = confirm(
                    `ÌòÑÏû¨ ${allLogs.length}Í∞úÏùò Î°úÍ∑∏Í∞Ä ÏûàÏäµÎãàÎã§.\n` +
                    `Í∞ÄÏ†∏Ïò¨ Î°úÍ∑∏: ${importData.logs.length}Í∞ú\n\n` +
                    `ÌôïÏù∏ÌïòÎ©¥ Í∏∞Ï°¥ Î°úÍ∑∏Î•º Î™®Îëê ÎçÆÏñ¥Ïì∞Í≥† ÏÉà Î°úÍ∑∏Î°ú ÍµêÏ≤¥Ìï©ÎãàÎã§.\n` +
                    `Ï∑®ÏÜåÌïòÎ©¥ Í∞ÄÏ†∏Ïò§Í∏∞Î•º Ï∑®ÏÜåÌï©ÎãàÎã§.`
                );

                if (!shouldOverwrite) {
                    showToast('Í∞ÄÏ†∏Ïò§Í∏∞Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 'info');
                    return;
                }
            }

            allLogs = importData.logs;

            // Î°úÍ∑∏ Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
            allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Ï†ÄÏû•ÏÜåÏóê Ï†ÄÏû•
            chrome.storage.local.set({ powerLogs: allLogs }, () => {
                if (chrome.runtime.lastError) {
                    throw new Error(chrome.runtime.lastError.message);
                }
                
                updateStats();
                renderLogs();
                showToast(`Î°úÍ∑∏ ${importData.logs.length}Í∞úÍ∞Ä Í∞ÄÏ†∏Ïò§Í∏∞ÎêòÏóàÏäµÎãàÎã§.`, 'success');
            });

        } catch (error) {
            console.error('Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
            showToast(`Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
        }
    };

    reader.onerror = function() {
        showToast('ÌååÏùº ÏùΩÍ∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
    };

    reader.readAsText(file);
    
    // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
    event.target.value = '';
}
